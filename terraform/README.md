# Infrastructure Deployment Recommendations

## Executive Summary

This infrastructure plan was generated by Inframate based on analyzing your application's requirements and codebase structure.

### Recommended AWS Services:

AWS::EC2,AWS::AutoScaling,AWS::ElasticLoadBalancingV2,AWS::VPC,AWS::Route53,AWS::IAM,AWS::CloudWatch,AWS::SecretsManager,AWS::DocDB,AWS::S3,AWS::NATGateway

## Detailed Recommendations

*   **Containerization (Future Step):** Although `has_docker` is false, strongly consider containerizing the application with Docker. This simplifies deployments, improves consistency across environments, and makes it easier to orchestrate with services like ECS or EKS in the future.
*   **VPC:** Deploy the application within a custom Virtual Private Cloud (VPC) for network isolation.
    *   **Public Subnets:** For internet-facing resources like the Application Load Balancer (ALB) and NAT Gateways. Span across at least two AZs for HA.
    *   **Private Subnets:** For application servers (EC2 instances) and the DocumentDB cluster. Span across at least two AZs for HA. This prevents direct internet access to these resources.
*   **Application Tier (EC2 & Auto Scaling):**
    *   Use an **Application Load Balancer (ALB)** to distribute incoming traffic across multiple EC2 instances in different AZs.
    *   Deploy EC2 instances within an **Auto Scaling Group (ASG)**. The ASG will automatically adjust the number of instances based on demand (e.g., CPU utilization) and replace unhealthy instances.
    *   Use a **Launch Template** for the ASG to define the EC2 instance configuration (AMI, instance type, user data, IAM role, security groups).
    *   **AMI:** Start with the latest Amazon Linux 2 AMI. Consider creating a custom AMI with Node.js, your application code, and dependencies pre-baked for faster launch times and immutable infrastructure.
    *   **User Data:** For initial setup, use EC2 user data scripts to install Node.js, clone your application (e.g., from an S3 bucket or CodeCommit/GitHub), install dependencies (`npm install`), and start the application (e.g., using `pm2`).
    *   **Instance Type:** Start with `t3.small` or `t3.medium` instances and monitor performance to right-size.
*   **Database Tier (Amazon DocumentDB):**
    *   Use **Amazon DocumentDB (with MongoDB compatibility)** as a managed NoSQL database service. It provides HA, automated backups, patching, and scalability.
    *   Deploy the DocumentDB cluster in the private subnets across multiple AZs.
*   **Security:**
    *   **IAM Roles:** Assign IAM roles to EC2 instances with least-privilege permissions (e.g., to access Secrets Manager, CloudWatch Logs, S3 if code is stored there).
    *   **Security Groups:**
        *   ALB Security Group: Allow inbound HTTP (80) and HTTPS (443) from the internet (`0.0.0.0/0`).
        *   Application EC2 Security Group: Allow inbound traffic from the ALB security group on the application port (e.g., 3000 or 8080). Allow outbound traffic to the internet (via NAT Gateway) for package installation and to the DocumentDB security group.
        *   DocumentDB Security Group: Allow inbound traffic from the Application EC2 security group on port 27017.
    *   **AWS Secrets Manager:** Store DocumentDB credentials securely. The application on EC2 instances will retrieve these credentials at runtime using the IAM role.
    *   **NAT Gateway:** Place NAT Gateways in public subnets to allow instances in private subnets to access the internet for updates, package installations, etc., without being directly exposed.
*   **Deployment Strategy (Post-Terraform):**
    *   While user data handles initial setup, for ongoing deployments, implement a CI/CD pipeline using AWS CodePipeline, AWS CodeBuild, and AWS CodeDeploy. CodeDeploy can manage rolling updates to your EC2 fleet.
*   **Logging and Monitoring:**
    *   **CloudWatch Logs:** Configure the EC2 instances (via CloudWatch Agent) to send application and system logs to CloudWatch Logs.
    *   **CloudWatch Metrics:** Monitor key metrics for ALB (request count, latency), EC2 (CPU, memory, network), and DocumentDB (CPU, connections, storage).
    *   **CloudWatch Alarms:** Set up alarms for critical metrics (e.g., high CPU, low disk space, unhealthy hosts) to trigger notifications (SNS) or auto-scaling actions.
*   **DNS:**
    *   Use **Amazon Route 53** to manage your application's domain name and point it to the ALB.
*   **Static Assets:**
    *   The `public` directory suggests static assets. Consider serving these from an **S3 bucket** fronted by **CloudFront (CDN)** for better performance and to offload the application servers. This is not included in the initial Terraform for simplicity but is a strong recommendation.

## Estimated Monthly Costs

This is a rough monthly estimate for a moderately used application in `us-east-1`. Costs can vary significantly based on actual usage, instance types chosen, data transfer, and region.
*   **VPC & Networking:**
    *   NAT Gateway (1 per AZ, assume 2 for HA):
        *   Hourly charge: 2 * $0.045/hr * 730 hrs/month = ~$65.70
        *   Data processing: $0.045/GB (Assume 50GB processed) = $2.25
    *   Application Load Balancer (1):
        *   Hourly charge: $0.0225/hr * 730 hrs/month = ~$16.43
        *   LCU cost: Highly variable. Assume 5 LCUs on average: 5 * $0.008/LCU-hr * 730 hrs/month = ~$29.20
*   **Compute (EC2 Auto Scaling Group):**
    *   Instances: 2 x `t3.small` (on-demand): 2 * $0.0208/hr * 730 hrs/month = ~$30.37
    *   EBS Storage (General Purpose SSD - gp3): 2 * 30GB * $0.08/GB-month = $4.80 (default IOPS/throughput free)
*   **Database (Amazon DocumentDB):**
    *   Cluster: 2 x `db.t3.medium` instances (for HA): 2 * $0.099/hr * 730 hrs/month = ~$144.54
    *   Storage: Assume 50GB: 50GB * $0.10/GB-month = $5.00
    *   I/O: Highly variable. Assume 1 million I/Os: 1 * $0.20/million = $0.20
    *   Backup Storage: Assume 50GB: 50GB * $0.021/GB-month = $1.05
*   **AWS Secrets Manager:**
    *   Secrets: 1 secret * $0.40/secret/month = $0.40
    *   API calls: 10,000 API calls * $0.05/10,000 calls = $0.05 (likely covered by free tier)
*   **CloudWatch:**
    *   Logs: Free tier for first 5GB ingested. Assume 10GB ingested: 5GB * $0.50/GB = $2.50
    *   Metrics: Custom metrics can add cost. Standard metrics are mostly free.
    *   Alarms: Free tier for first 10 alarms.
*   **Route 53 (Optional, if managing domain):**
    *   Hosted Zone: $0.50/month
    *   Standard Queries: Negligible for low traffic.
**Estimated Total Monthly Cost (Rough):**
$65.70 (NAT) + $2.25 (NAT Data) + $16.43 (ALB) + $29.20 (ALB LCU) + $30.37 (EC2) + $4.80 (EBS) + $144.54 (DocDB Inst) + $5.00 (DocDB Store) + $0.20 (DocDB IO) + $1.05 (DocDB Backup) + $0.40 (Secrets) + $0.05 (Secrets API) + $2.50 (Logs) + $0.50 (R53)
**= ~$302.99 per month**
**Note:**
*   This estimation assumes on-demand pricing. Significant savings (30-60%) can be achieved with Reserved Instances or Savings Plans for EC2 and DocumentDB if you can commit to 1 or 3 years.
*   Data transfer OUT to the internet from ALB/EC2 is an additional cost ($0.09/GB after the first 100GB/month free tier).
*   This is a starting point. Monitor your actual usage and adjust instance types/counts accordingly.

*Note: These cost estimates are approximate and may vary based on usage patterns, region, and AWS pricing changes.*

## Deployment Instructions

1. **Prerequisites**:
   - AWS CLI configured with appropriate credentials
   - Terraform installed (v1.0.0+)

2. **Configuration**:
   - Update variables in `terraform.tfvars` to match your requirements
   - Review the Terraform files to ensure they meet your needs

3. **Deployment**:
   ```bash
   terraform init
   terraform plan
   terraform apply
   ```

4. **Cleanup**:
   ```bash
   terraform destroy
   ```

## Notes

- The Terraform files have been generated in the `terraform/` directory
- The configuration is based on the application requirements specified in `inframate.md`
- You may need to customize the Terraform files for your specific needs
